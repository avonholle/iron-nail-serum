---
title: "Data handling for iron project: Associations between serum and toenail measures of iron"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    includes:
      in_header: ../preamble-latex-nobookdown.tex
      latex_engine: pdflatex 
      keep_tex: yes
      toc: yes
      toc_depth: 3
      number_sections: true
  html_document:
    theme: united
    toc: yes
fig.cap: yes
editor_options:
  chunk_output_type: console
geometry: margin=1.5cm
urlcolor: blue
linkcolor: magenta
citecolor: red
---

<!-- NOTE: Only run if new data. -->

# Data handling for the R project

```{r , include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      results = 'hide',
                      warning = F,
                      tidy.opts=list(width.cutoff=80),
                      tidy=TRUE,
                      comment=NA,
                      prompt=F,
                      cache=F)

#runif(1, 0, 10^8)
set.seed(74268794)

```


```{r, include=F}
# bring in packages

require("DiagrammeR")
require(haven)

require(labelled)
require(tableone)
require(summarytools)

```



```{r, eval=T}

# read original SAS data into R
df1. =  read_sas(data_file="../../Sister Study/data/dr00224_01_02/dr00224_01_02.sas7bdat",
                 catalog_file = "../../Sister Study/formats-subset/sisformats.sas7bcat" ) # got a failed to parse error. see https://github.com/WizardMac/ReadStat/issues/42

class(df1.)

with(df1.[df1.$UMN_Iron==1,], table(UMN_Iron_Subcohort, FU_BCInvD_Event, useNA="always")) 

pblm.ids = df1.[df1.$UMN_Iron==1 & (df1.$FU_BCInvD_Event==0 & is.na(df1.$UMN_Iron_Subcohort)),]$PSID
tot = pblm.ids[complete.cases(pblm.ids)]; tot
write.csv(tot, file="question-ids.csv")

# get names of iron and nail variables

iron.names = grep("Iron", names(df1.))
iron.names2 = names(df1.[iron.names]); iron.names2

nail.names = grep("nail", names(df1.)); nail.names
nail.names2 = names(df1.[nail.names]); nail.names2

sclage.names = grep("SCL_Serum", names(df1.)); sclage.names
sclage.names2 = names(df1.[sclage.names]); sclage.names2

serum.names = grep("Serum", names(df1.)); serum.names
serum.names2 = names(df1.[serum.names]); serum.names2

summary(df1.[serum.names2])

```

```{r}
# get counts of toenail measures.
# are they the same as original files with all toenail metal measures?

table(is.na(df1.$DC_Baseline_Toenail_Fe)) # 1438 Dartmouth fe nail measures

table(is.na(df1.$RTI_Toenail_fe)) # 2996 RTI fe nail measures

```


```{r}

df2 = df1.[, c('PSID', 'FU_BCInvD_Event',
              'AgeExact_Baseline',
              'FU_BCInvD_EOFAgeExact',
              'FU_BCInvD_EOFAge', "HH_PSID",
              'FU_BCInvD_DxAgeExactMax',
              'FU_BCInvD_DxAgeExactMin',
              'DR224_FU_BCInvD_Event_Serum',
              "FU_BC_Event",
              'SCL_BC_Event',
              iron.names2, nail.names2, serum.names2)]
dim(df2) # 50,884

names.vars = c('PSID', "event", 
              'baseline.age',
              'FU_BCInvD_EOFAgeExact',
              'FU_BCInvD_EOFAge', 'HH_PSID',
              'FU_BCInvD_DxAgeExactMax',
              'FU_BCInvD_DxAgeExactMin',
              'DR224_FU_BCInvD_Event_Serum',
              "FU_BC_Event",
              'SCL_BC_Event',
              iron.names2, nail.names2, serum.names2)

colnames(df2) = names.vars
df2 = data.frame(df2)

df2 = within(df2, {
  c.age = ifelse(is.na(FU_BCInvD_EOFAgeExact),
                    FU_BCInvD_EOFAge + round(runif(nrow(df2),0,1), 2), 
                    FU_BCInvD_EOFAgeExact)
  start.age = baseline.age
  futime = c.age - start.age
  
})


# follow-up time for total sample?
summary(df2$futime)
summary(df2$FU_BCInvD_EOFAgeExact - df2$baseline.age)
summary(df2$FU_BCInvD_EOFAge- df2$baseline.age)
summary(df2$c.age)

head(df2[which(df2$futime<0), c("futime", "FU_BCInvD_EOFAgeExact", "FU_BCInvD_EOFAge", "baseline.age", "c.age", "event")])

# select people from study
df2 = df2[df2$UMN_Iron==1,]
dim(df2) # 6011
summary(df2$futime)

table(as_factor(df2$DR224_FU_BCInvD_Event_Serum))


df2 = df2[which(complete.cases(df2$PSID)),]
dim(df2)  # eliminate people who overlap in prospective BRCA study and twice studied validation). see "Sampling Protocol for Iron Project based on Iron Panel Assays in Serum_20190715.docx"

table(as_factor(df2$UMN_Iron_Subcohort))

```


```{r, eval=F, include=F}
# check number of cases in subcohort to make sure it matches with
# "Sampling Protocol for Iron Project based on Iron Panel Assays in Serum_20190715.pdf" document
# that document has 125+78 = 203 cases

table(as_factor(df2$UMN_Iron_Subcohort), df2$event)
# 222 cases. The 222 cases were from release 7 and 203 cases were from release 6 when the document was made (see 4/15/2020 email from Deb Bookwalter)

```


```{r}

df3. = df2
dim(df3.)

# Get labels back
df3. <- df3. %>% copy_labels_from(df1.) # Source: http://larmarange.github.io/labelled/reference/copy_labels.html

# create a subcohort binary variable: 1=subcohort 0=not

df3.$UMN_Iron_Subcohort[is.na(df3.$UMN_Iron_Subcohort)] = 0 # convert missing to 0s
head(df3.$UMN_Iron_Subcohort) # check
dim(df3.)
table(is.na(df3.$PSID))


table(df3.$UMN_Iron_Subcohort)  # check. This matches numbers in documentation.

with(df3., table(UMN_Iron_Subcohort, event))
with(df3., sum(table(UMN_Iron_Subcohort, event)))
df3.$iron.study = df3.$UMN_Iron

head(df3.[which(df3.$UMN_Iron_Subcohort==0 & df3.$event==0), c("PSID", "UMN_Iron_Baseline_FE",
                                                        "iron.study", "UMN_Iron_Subcohort",
                                                        "UMN_Iron_SCL_BCInvD_Event", "event",
                                                        "start.age", "c.age")], 15)

psid.exclude.noevent = df3.[which(df3.$UMN_Iron_Subcohort==0 & df3.$event==0),]$PSID
psid.exclude.noevent
# people are not in subcohort, but they do not have an event. Will exclude later

# One of these participants is labeled as cases with UMN_Iron_SCL_BCInvD_Event (UMN Iron: Prospective BrCa Survivor Study, SCL BrCa case status at time of sampling (1=dx before SCL blood draw 0=dx after SCL Blood Draw) [data release 6.0])

head(df1.[df1.$PSID %in% c('00224_200085'),c("PSID",  "UMN_Iron_Baseline_FE", "UMN_Iron_Subcohort",
                                 "UMN_Iron_Validation", "UMN_Iron_SCL_BCInvD_Event", "FU_BCInvD_Event",
                                 "AgeExact_Baseline", "FU_BCInvD_EOFAge")])

with(df3., table(UMN_Iron_Subcohort, event))
table(df3.$UMN_Iron_Subcohort)

df3.$subcohort = df3.$UMN_Iron_Subcohort
with(df3., table(subcohort, event))

nrow(df3.)
table(df3.$subcohort)

with(df3., table(subcohort, event, useNA="always"))
table(df3.$subcohort)

```



### Remove participants who are missing all iron measures (6008 - 5952 = 56)

```{r}


df4 = df3.[!(is.na(df3.$UMN_Iron_Baseline_FE)) |
           !(is.na(df3.$UMN_Iron_Baseline_FERTN)) |
           !(is.na(df3.$UMN_Iron_Baseline_FESAT)),]

dim(df4) # with at least one non-missing iron val, 5926
dim(df3.) - dim(df4) # remove 56 with missing baseline iron values

dim(df3.) # 6008 - 5952 = 56 

```



### Include participants from subcohort (exclude cases) (5952 - 2781 = 3171)

```{r}

df5 = df4[df4$subcohort==1,]

dim(df5) # with at least one non-missing iron val, 3171
dim(df4) - dim(df5) # remove 2781 from cases

dim(df4) # 5952 - 2781 = 3171

```


```{r}

psid.include = df5$PSID
length(psid.include)  # 3171
psid.include2 = df4$PSID

save(psid.include, psid.include2, file="ids-include.RData")

table(df5$subcohort, df5$event)

```



```{r, eval=F, include=F}
# NOTE: run this separately, go to viewer, select Export|Copy to Clipboard, enlarging width while keeping aspect ratio. Then paste into Microsoft Paint program and crop to fit. Save as flowchart.png. (or save as png directly in viewer as Export|Save as Image)


# sources: https://www.graphviz.org/Documentation/TSE93.pdf
# https://stackoverflow.com/questions/27110526/how-to-manage-distance-between-nodes-in-graphviz
fig.sample <- "
digraph flow2 {

  # several 'node' statements
  node [shape = box,
        fontname=Arial, fontsize=50,
        color = black]; // for the letter nodes, use box shapes

# Source: https://graphviz.readthedocs.io/en/stable/manual.html
  edge [arrowhead=vee arrowsize=4 ]

  Z[label=\"n=6,008 \"];
  Z1[label=\"Missing at least one \niron measure (n=56)\"];

  A[label=\"n=5,952\"]; 

  A1[label=\"Cases (n=2781)\"];

  C[label=\"n=3,171 \n from subcohort\"]; 
  
  {rank = same; Z Z1}
  {rank = same; A A1}
  {rank = same; C}
  
  # several 'edge' statements
  edge [color = black] // this sets all edges to be black (unless overridden)

    Z -> Z1;
    Z -> A;

    A -> A1;
    A -> C;
    
  # a 'graph' statement
  graph [overlap = true
        nodesep=\"1\",
        ranksep=\"1\"]
}
"

grViz(fig.sample)
```


![Exclusions](../sections/flow-sample-cch.png)


<!-- ======================================================== -->
<!-- END OF SAMPLE SELECTION, START OF DATA HANDLING -->
<!-- ======================================================== -->

```{r}

iron.supp.vars = c(
              'TQ75',
              'TQ75a',
              'TQ75b',
              'TQ75c',
              'LL94',
              'LL94a',
              'LL94b',
              'LL94c')

ida.vars = c('MC116',
              'MC117')

#lmp.vars = c('FU_BCInv_LMP',
#             'FU_BCInv_LMPExact',
#             'FU_BCInv_LMPStatus')

blood.vars = c('MC234',
              'MC236',
              'MC235no',
              'MC235un')


df2 = df1.[, c('PSID', 'FU_BCInvD_Event',
              'HR_Menopause', 
              'HR_MenopauseAge',
              'AgeExact_Baseline',
              'HZ_SM_SmokeStatusN',
              'FU_BC_AL_Status',
              'SE18',
              'EX_BMI_final',
              'EX_BMI_CDC_final',
              'Ex_Waist',
              'Ex_Height_final',
              'HZ_HR_HRT_Ever',
              'PG_TermNum',
              'HR_HR1Ever',
              'AgeExact_Baseline',
              'FU_BCInvD_EOFAgeExact',
              'FU_BCInvD_EOFAge',
              'FU_BCInvD_MenopauseAge',
              'Study',
              'MC234',  # MC234 (Main) MC218 (Vanguard). R has ever given blood
              'MC236', # MC236 (Main) MC220 (Vanguard). Given blood in past 12 mos
              'MC235no', # MC235 (Main) MC219 (Vanguard). # of times/gallons blood donated
              'MC235un', # MC235 (Main) MC219 (Vanguard). unit (times/gallons) blood donated
              'HH_PSID',
              "PG_MedParity",'PG_MenarcheAge',
              'PG_AgeFirstLiveBirth', 
              'FU_BCInvD_DxType', 'MC114', "MC115",
              'FU_BC_DxPR_Result', 'FU_BC_DxER_Result', 'FU_BCInvD_DxHER2_Result',
              'UMN_Iron_Subcohort',
              'UMN_Iron_Validation',
              'SE_RACE15', 'SE_RACE_ETH',
              "UMN_Iron_SCL_BCInvD_Event",
              "FU_BCInvD_DxAgeExactMax", "FU_BCInvD_DxAgeExactMin",
              iron.supp.vars, blood.vars, ida.vars,  nail.names2, iron.names2, serum.names2,
              "UMN_Iron_Baseline_FE", "UMN_Iron_Baseline_FERTN",
              "UMN_Iron_Baseline_UIBC", "UMN_Iron_Baseline_TIBC", "UMN_Iron_Baseline_FESAT",
              'RTI_Toenail_fe', 'RTI_Toenail_fe_Adj', 'RTI_Toenail_Source', 'FU_BCInvD_Menopause',
              'HZ_HR_Menopause',
              'HZ_HR_MenopauseAge',
              'HZ_HR_MenopauseAgeExact',
              'HZ_HR_MenopauseSource',
              'HZ_HR_MenopauseSourceAgeExact',
              'HZ_HR_MenopauseStatus',
              'HR34', 'HR35',
              'HZ_HR_Hyst', 'HZ_HR_HystAge', 'HZ_HR_HystAgeExact', 'HZ_HR_Hyst_FUsource', 
              'HZ_HR_Hyst_FUsource_AgeExact')]

dim(df2) # 50,884
length(names(df2))

names.vars = c('PSID', "event", 
               "menop.status", 
               "menop.age",
               'baseline.age',
               'smoke',
               'alc',
               'educ',
               'bmi',
               'EX_BMI_CDC_final',
               'waist',
               'height',
               'ever.hrt',
               'term.births',
               'birth.control',
               'AgeExact_Baseline',
              'FU_BCInvD_EOFAgeExact',
              'FU_BCInvD_EOFAge',
              'fu.meno.age',
              'study', 
              'ever.donate.b',
              'donate.b.12',
              'no.times.donate.b',
              'unit.donate.b', 'HH_PSID',
               "parity", 'age.menarche',
               "age.firstbirth",
              "FU_BCInvD_DxType", 'MC114', "MC115",
              'FU_BC_DxPR_Result', 'FU_BC_DxER_Result', 'FU_BCInvD_DxHER2_Result',
              'UMN_Iron_Subcohort',
              'UMN_Iron_Validation',
              'SE_RACE15', 'SE_RACE_ETH',
              "UMN_Iron_SCL_BCInvD_Event",
              "FU_BCInvD_DxAgeExactMax", "FU_BCInvD_DxAgeExactMin",
              iron.supp.vars, blood.vars, ida.vars, nail.names2, iron.names2, serum.names2,
              'fe', 'fertn', 'fesat', 'tibc', 'uibc',
              'RTI_Toenail_fe', 'RTI_Toenail_fe_Adj', 'RTI_Toenail_Source', 'FU_BCInvD_Menopause',
              'HZ_HR_Menopause',
              'HZ_HR_MenopauseAge',
              'HZ_HR_MenopauseAgeExact',
              'HZ_HR_MenopauseSource',
              'HZ_HR_MenopauseSourceAgeExact',
              'HZ_HR_MenopauseStatus', 'HR34', "HR35",
              'HZ_HR_Hyst', 'HZ_HR_HystAge', 'HZ_HR_HystAgeExact', 'HZ_HR_Hyst_FUsource', 
              'HZ_HR_Hyst_FUsource_AgeExact')

length(names.vars)

colnames(df2) = names.vars
summary(df2)

```



```{r}

# NOTE: 
# after 3/2020 draft review of 'Association between serum iron biomarkers and breast cancer' manuscript, suggestion we use min/max follow-up age to find a follow-up age instead of removing from sample.

df2$median = apply(df2[c("FU_BCInvD_DxAgeExactMax", "FU_BCInvD_DxAgeExactMin")], 1, median)
head(df2[is.na(df2$FU_BCInvD_EOFAgeExact), c("event", 
                                     "FU_BCInvD_DxAgeExactMax", "FU_BCInvD_DxAgeExactMin",
                                     "FU_BCInvD_EOFAgeExact", "FU_BCInvD_EOFAge", 
                                      "median")])

```

```{r}

df2 = data.frame(df2) # note that need data frame format for within function to work below

# some more data handling
class(df2)

df2 = within(df2, {
  # Make age at first birth categorical variable
  age.firstbirth.rev = ifelse(is.na(age.firstbirth)==T, -1, age.firstbirth) # make nulliparous its own category
  age.firstbirth.cat = cut(age.firstbirth.rev, c(-1, 0, 20, 24, 29, 55), include.lowest = T)
  age.firstbirth.cat = relevel(age.firstbirth.cat, ref="(20,24]")

  age.firstbirth.cat.table = factor(age.firstbirth.cat,
                                    levels = c("[-1,0]",
                                               "(0,20]",
                                               "(20,24]",
                                               "(24,29]",
                                               "(29,55]"))
  
  # serum ages
  serum.age = ifelse(!(is.na(Serum_Draw_AgeExact)), Serum_Draw_AgeExact,
                     ifelse(Serum_Draw==1, Serum_Draw_Age + runif(nrow(df2), 0, 1), NA)) # if exact age missing, and a draw then put draw age + random uniform # between 0,1

  scl.serum.age = ifelse(!(is.na(SCL_Serum_Draw_AgeExact)), SCL_Serum_Draw_AgeExact,
                         ifelse(SCL_Serum_Draw==1, SCL_Serum_Draw_Age + runif(nrow(df2),0,1), NA)) # if exact age missing, and a draw then put draw age

  serum.age.diff = scl.serum.age - serum.age

  # nail ages
  nail.age = ifelse(!(is.na(DC_Baseline_Toenail_AgeExact)), DC_Baseline_Toenail_AgeExact,
                     ifelse(SCL_Toenails_Collected==1, DC_Baseline_Toenail_Age + runif(nrow(df2), 0, 1), NA)) # if exact age missing, and a draw then put draw age + random uniform # between 0,1

  scl.nail.age = ifelse(!(is.na(DC_SCL_Toenail_AgeExact)), DC_SCL_Toenail_AgeExact,
                         ifelse(SCL_Toenails_Collected==1, DC_SCL_Toenail_Age + runif(nrow(df2),0,1), NA)) # if exact age missing, and a draw then put draw age

  nail.age.diff = scl.nail.age - nail.age

  
  })

table(df2$age.firstbirth.cat.table)
summary(df2$serum.age.diff)
summary(df2$nail.age.diff)

sapply(df2[,c('fe', 'fertn', 'fesat', 'tibc', 'uibc')],
       summary)

```

```{r}
# misc
table(as_factor(df2$birth.control))

```


```{r}

# check transferrin calc
df2$calc.fesat = with(df2, round((fe/(fe+uibc))*100, 0))
head(df2[c("fesat", "calc.fesat")])

df2$fesat.diff = with(df2, fesat-calc.fesat)
head(df2[which(df2$fesat.diff==1), c("fesat", "calc.fesat", "fesat.diff")]) # there might be some with different rounding practices or my measures are not as precise as theirs for calcs.
table(df2$fesat.diff)   

with(df2, summary(fesat-calc.fesat))
with(df2, summary(fesat - ((fe/tibc)*100)))

```


```{r}

# menopause ==================
attributes(df2$menop.status) # look up format in ../data/sas-contents.pdf file
df2$menop.status.f = zap_missing(df2$menop.status)
df2$menop.status.f = as_factor(df2$menop.status.f)
table(df2$menop.status.f)

# smoking ===============================
attributes(df2$smoke) # HZSMSTAT.
df2$smoke.f = zap_missing(df2$smoke)
df2$smoke.f = as_factor(df2$smoke.f)
table(df2$smoke.f)

# combine 2 unk groups into 1
df2$smoke.f2 = factor(df2$smoke,
                     labels = c("Never",
                                "Former",
                                "Former",
                                "Current"))
table(df2$smoke.f2)

# Alcohol ===========================
attributes(df2$alc) # alcstatus.
df2$alc.f = zap_missing(df2$alc)
df2$alc.f = as_factor(df2$alc.f)
table(df2$alc.f)


# collapse
df2$alc.f2 = factor(df2$alc,
                   labels = c('Never drank',
'Social',
'Social',
'Social',
'Regular',
'Regular',
'Regular',
'Unknown',
'Unknown',
'Unknown'))

table(df2$alc.f2)


# collapse
df2$alc.f3 = factor(df2$alc,
                   labels = c('Never drank',
'Past',
'Current',
'Unk',
'Past',
'Current',
'Unk',
'Unk',
'Unk',
'Unk'))

table(df2$alc.f3)

df2$alc.f4 = ifelse(df2$alc.f3=="Unk", NA, as_factor(df2$alc.f3))
df2$alc.f4 = factor(df2$alc.f4, labels = c("Never", "Past", "Current"))
table(df2$alc.f4)

# Education ===========================
attributes(df2$educ) # SEEDUC.
df2$educ.f = zap_missing(df2$educ)
df2$educ.f = as_factor(df2$educ.f)
table(df2$educ.f)

# combine doctoral and masters and lowest 3 levels
df2$educ.f2 = factor(df2$educ.f,
                   labels = c(
                      "1-3 < high school degree", # no one with no formal schooling
                      "1-3 < high school degree",
                      "1-3 < high school degree",
                      "4-5) Completed high school or GED",
                      "4-5) Completed high school or GED",
                      "6) Some college but no degree",
                      "7) Associate or technical degree",
                      "8) Bachelor's degree",
                      "9 \\& 10) Doctoral or Master's degree",
                      "9 \\& 10) Doctoral or Master's degree"
                   ))
table(df2$educ.f2)

# HRT ====================================
attributes(df2$ever.hrt) # HRYESNO.
table(df2$ever.hrt)
df2$ever.hrt.f = factor(df2$ever.hrt, labels = c("No", "Yes"))
table(df2$ever.hrt.f)

# term.births ============================================
attributes(df2$term.births) # PGMISS.
df2$term.births = as.numeric(zap_missing(df2$term.births))
table(df2$term.births)
class(df2$term.births) # numeric

# at least one term birth ================================
df2$one.term.birth = with(df2, ifelse(term.births>0, 1, 0))
table(df2$one.term.birth)
df2$one.term.birth.f = factor(df2$one.term.birth,
                              labels = c("No", "Yes"))

# birth control =========================================
attributes(df2$birth.control) # HRGRID.
table(df2$birth.control)
df2$birth.control.f = factor(df2$birth.control, 
                             labels = c("No", "Yes"))
table(df2$birth.control.f, useNA = "always")

# ever donate blood =======================
attributes(df2$ever.donate.b)
levels(factor(df2$ever.donate.b))
df2$ever.donate.b.f = factor(df2$ever.donate.b, labels=c("No", "Yes"))
  
levels(factor(df2$study))
table(as_factor(df2$study))

df2$study.f2 = factor(df2$study, labels = c("Vanguard", "Main"))
# 1=Vanguard, 2=Main, 3=Two Sisters
table(df2$study.f2)


# race/ethnicity =========================================
attributes(df2$SE_RACE_ETH)
df2$race.eth = zap_missing(df2$SE_RACE_ETH)
df2$race.eth = as_factor(df2$race.eth)
table(df2$race.eth)
df2$race.eth = factor(df2$race.eth, 
                      labels = c("Non-Hispanic White",
                                 "Non-Hispanic Black",
                                 "Hispanic",
                                 "Other"))
# BMI categories ==================================
attributes(df2$EX_BMI_CDC_final)
df2$bmi.cat = as_factor(zap_missing(df2$EX_BMI_CDC_final))
table(df2$bmi.cat)


df2 = within(df2, {
  c.age = ifelse(is.na(FU_BCInvD_EOFAgeExact),
                    FU_BCInvD_EOFAge + round(runif(nrow(df2),0,1), 1), 
                    FU_BCInvD_EOFAgeExact)
  start.age = AgeExact_Baseline
  futime = c.age - start.age
  
  # time since menopause (years)
  time.since.menop = ifelse(is.na(menop.age), 0, start.age - menop.age)
  
  # time menstruating (years)
  yrs.mens = ifelse(is.na(menop.age),
                    start.age - age.menarche - parity,
                    menop.age - age.menarche - parity
                    ) # Note: this variable original in table12.Rmd from age of onset project.
  
  # early menopause variable
  early.menop.45 = ifelse(is.na(menop.age), 0,
                          ifelse(menop.age<45, 1, 
                                 ifelse(menop.age<80, 2, NA))) # we will be missing the people who have early menopause after enrollment
  
  early45 = ifelse(is.na(menop.age), 0, 
                   ifelse(menop.age<45, 1, 0)) 
  menop = ifelse(is.na(menop.age), 0, 1)
})

with(df2, table(early45, menop, early.menop.45, exclude=NULL))
table(df2$early.menop.45)

df2$futime = with(df2, ifelse(is.na(futime), c.age-baseline.age, futime))
summary(df2$futime)
dim(df2)

prop.table(table(df2$early.menop.45))
#with(df2, table(early.menop.45, menop.age)) # double check variable.

```



```{r}

df2$scl.2 = ifelse(is.na(df2$UMN_Iron_SCL_FE), 0, 1)
df2$UMN_Iron_Subcohort[is.na(df2$UMN_Iron_Subcohort)] = 0 # convert missing to 0s
df2$subcohort = df2$UMN_Iron_Subcohort
table(df2$subcohort)

df2$subcohort.nocases = with(df2, ifelse((subcohort==1 & event==0), 1, 0))
with(df2, table(subcohort.nocases, event))

nrow(df2)

all.dat = df2 # create total data set with derived variables for export

```



```{r}

# get counts of cases in subcohort

table(df2$UMN_Iron)
table(df2$subcohort)
with(df2, table(UMN_Iron, subcohort))
with(df2[df2$UMN_Iron==1,], table(subcohort, event))

```


```{r}
# Subset to sample

df3 = df2[which(df2$PSID %in% psid.include),]
nrow(df3)

# Change c.age (end of follow-up to include 9 people who are missing follow-up age) -- see data-handling-cch.Rmd
summary(df3$c.age)
df3$c.age = with(df3, ifelse(is.na(c.age), 
                             median,
                             c.age))
summary(df3$c.age)

head(df3[, c("event", 
             "FU_BCInvD_DxAgeExactMax", "FU_BCInvD_DxAgeExactMin",
             "FU_BCInvD_EOFAgeExact", "FU_BCInvD_EOFAge", 
             "c.age")])


df3$UMN_Iron_Subcohort[is.na(df3$UMN_Iron_Subcohort)] = 0 # convert missing to 0s
df3$subcohort = df3$UMN_Iron_Subcohort
table(df3$subcohort)
names(df3)

df3$subcohort.nocases = with(df3, ifelse((subcohort==1 & event==0), 1, 0))
with(df3, table(subcohort.nocases, event))

with(df3, table(subcohort.nocases, event, is.na(SCL_Serum_Draw)))
```


```{r}
# Get labels back for subsetted data

dim(df2) # 50884 by 126
attributes(df2$AgeExact_Baseline)
attributes(df3$AgeExact_Baseline)


# Problem with haven and subsetting: https://github.com/tidyverse/haven/issues/392
# Get labels back
df3 <- df3 %>% copy_labels_from(df1.) # Source: http://larmarange.github.io/labelled/reference/copy_labels.html
attributes(df3$AgeExact_Baseline) # gets labels back

sub.dat = df3
dim(sub.dat)
table(sub.dat$event)
```


```{r}

save(all.dat, sub.dat, nail.names2, iron.names2, serum.names2, 
     file="../sections/updated-data-iron.RData") # sub.dat is subset, all.dat is total data

```

