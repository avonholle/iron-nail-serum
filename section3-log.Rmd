---
title: "Section 3: Spearman’s rank correlation coefficient"
output:
  pdf_document:
    number_sections: yes
    toc: no
    highlight: tango
  html_document:
    theme: united
    toc: no
editor_options:
  chunk_output_type: console
header-includes:
 \usepackage{float}
---


```{r setup3, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      results = 'markup',
                      warning = F,
                      fig.pos = 'H',
                      results="hide")

#runif(1, 0, 10^8)
set.seed(74268794)

```


```{r, include=F}
# bring in packages
require(knitr)
require(haven)
require(data.table)
require(ggplot2)
require(kableExtra)
library(dplyr)
library(tidyr)
library(plyr)

```


```{r}

load(file="../sections/updated-data-iron.RData") # sub.dat is subset, all.dat is total data

nail.names2
iron.names2
serum.names2

# NOTE: have to run section5-spearman.Rmd first 
load(file="pca-info.RData") # pca.log, loading.matrix, pc.info

dim(sub.dat)
sub.dat = merge(sub.dat, pc.info, by="PSID", all.x=T)
dim(sub.dat)
summary(sub.dat[c("PC1", "PC1.scl")])

sub.dat.cc = sub.dat[complete.cases(sub.dat[,c("UMN_Iron_Baseline_FE", "DC_Baseline_Toenail_Fe")]),]
head(sub.dat.cc)
dim(sub.dat.cc)

x = sub.dat$UMN_Iron_Baseline_FERTN
y = sub.dat$DC_Baseline_Toenail_Fe
cor.test(x,y,
         method="spearman")

```

```{r}

# Get ids for analysis subset

# Source: frequencies.Rmd
load(file="ids-include-basefu.RData") # baseline.all.id, fu.all.id, base.fu.all.id

# fu.all.id = id of people with all serum and nail measures at follow-up 
# baseline.all.id = id of people with all baseline serum and nail measures
# base.fu.all.id =  id of people with all baseline serum and nail measures AND follow-up measures

```


# Spearman’s rank correlation coefficient # {#spearman}

## Baseline


```{r}
# Make long style data frame 

dat.long. <- 
  sub.dat %>% 
  dplyr::select(c(UMN_Iron_Baseline_FE, UMN_Iron_Baseline_FERTN, UMN_Iron_Baseline_FESAT, PC1,
                  subcohort.nocases,
                  PSID)) %>% 
  pivot_longer(cols = -c("PSID", 'subcohort.nocases'),
               values_drop_na=T)
dim(dat.long.)

dat.long. = within(dat.long., {
  no.case = factor(subcohort.nocases,
                   labels=c("No", "Yes"))
  name.f = factor(name, labels=c("PC1", "Iron", "Ferritin", "Transferrin Saturation"))
})


dat.long = merge(dat.long., sub.dat[complete.cases(sub.dat$DC_Baseline_Toenail_Fe),
                                                   c("PSID", "DC_Baseline_Toenail_Fe")], 
                 by="PSID",
                 all.y=T)

levels(factor(dat.long$name))

colnames(dat.long)[which(colnames(dat.long) %in% "DC_Baseline_Toenail_Fe")]="Nail"

head(dat.long)
dim(dat.long)

head(dat.long)


```


### Spearman's rank correlation at baseline with outlier


```{r, results="markup"}

spearman.f = function(df){
  x=log(df$Nail)
  y=log(df$value)
  corr1 <- cor.test(x, y, method = 'spearman')
  
  ct = min(length(x), length(y))

  return(c(corr1$estimate, corr1$p.value, ct))
  
}

# Source: https://stackoverflow.com/questions/1169539/linear-regression-and-group-by-in-r
# Break up data frame by iron measure, then fit the specified model to each piece and
# return a list
sp.dat <- dlply(dat.long, "name.f", spearman.f)
# return a data frame
sp.dat.df = ldply(sp.dat)

names(sp.dat.df)=c("Serum measure", "rho", "p-value")
sp.dat.df

```


### Spearman's rank correlation at baseline without outlier

#### Outlier information

```{r, results="markup"}

extreme.id = sub.dat[which(sub.dat$DC_Baseline_Toenail_Fe==max(sub.dat$DC_Baseline_Toenail_Fe, na.rm=T)),]$PSID
extreme.id

sub.dat[sub.dat$PSID %in% c(extreme.id),]$DC_Baseline_Toenail_Fe

```

#### Spearman correlation statistic

```{r, results="markup"}

dat.long1 = dat.long[!(dat.long$PSID %in% extreme.id),]

dat.long1.baseline = dat.long1[dat.long1$PSID %in% baseline.all.id,]

sub.dat.bf = sub.dat[sub.dat$PSID %in% baseline.all.id,]

with(sub.dat.bf,cor.test(DC_Baseline_Toenail_Fe, UMN_Iron_Baseline_FESAT, method='spearman'))

# Source: https://stackoverflow.com/questions/1169539/linear-regression-and-group-by-in-r
# Break up data frame by iron measure, then fit the specified model to each piece and
# return a list
sp.dat1 <- dlply(dat.long1.baseline, "name.f", spearman.f)
# return a data frame
sp.dat1.df = ldply(sp.dat1)
names(sp.dat1.df)=c("Serum measure", "rho", "p-value")
sp.dat1.df

```


## Time 2


```{r}
# Make long style data frame for 3 panel plot

dat.long.t2. <- 
  sub.dat %>% 
  dplyr::select(c(UMN_Iron_SCL_FE, UMN_Iron_SCL_FERTN, UMN_Iron_SCL_FESAT, PC1.scl,
                  subcohort.nocases,
                  PSID)) %>% 
  pivot_longer(cols = -c("PSID", 'subcohort.nocases'),
               values_drop_na=T)


dat.long.t2 = merge(dat.long.t2., sub.dat[complete.cases(sub.dat$DC_Baseline_Toenail_Fe),
                                                   c("PSID", "DC_Baseline_Toenail_Fe")], 
                 by="PSID")

levels(factor(dat.long.t2$name))

dat.long.t2 = within(dat.long.t2, {
  no.case = factor(subcohort.nocases,
                   labels=c("No", "Yes"))
  name.f = factor(name, labels=c("PC1", "Iron", "Ferritin", "Transferrin Saturation"))
})

colnames(dat.long.t2)[which(colnames(dat.long.t2) %in% "DC_Baseline_Toenail_Fe")]="Nail"

head(dat.long.t2)
dim(dat.long.t2)
length(unique(dat.long.t2$PSID))
summary(dat.long.t2)

dat.long.t2.baseline.fu = dat.long.t2[dat.long.t2$PSID %in% base.fu.all.id,]

```

### Spearman's rank correlation at baseline with outlier

```{r, results="markup"}

# Source: https://stackoverflow.com/questions/1169539/linear-regression-and-group-by-in-r
# Break up data frame by iron measure, then fit the specified model to each piece and
# return a list
sp.dat2 <- dlply(dat.long.t2, "name.f", spearman.f)
# return a data frame
sp.dat2.df = ldply(sp.dat2)
names(sp.dat2.df)=c("Serum measure", "rho", "p-value")
sp.dat2.df

```


### Spearman's rank correlation at baseline without outlier

#### Outlier information

```{r, results="markup"}

extreme.id2 = sub.dat[which(sub.dat$DC_SCL_Toenail_Fe==max(sub.dat$DC_SCL_Toenail_Fe, na.rm=T)),]$PSID
extreme.id2

sub.dat[sub.dat$PSID %in% c(extreme.id2),]$DC_SCL_Toenail_Fe

```

#### Spearman correlation statistic


```{r, results="markup"}

# Source: https://stackoverflow.com/questions/1169539/linear-regression-and-group-by-in-r
# Break up data frame by iron measure, then fit the specified model to each piece and
# return a list
sp.dat2 <- dlply(dat.long.t2, "name.f", spearman.f)
# return a data frame
sp.dat2.df = ldply(sp.dat2)
names(sp.dat2.df)=c("Serum measure", "rho", "p-value")

sp.dat2.df

```

without outlier

```{r, results="markup"}

dat.long.t2.2 = dat.long.t2[!(dat.long.t2$PSID %in% extreme.id2),]

sp.dat3 <- dlply(dat.long.t2.baseline.fu, "name.f", spearman.f)
# return a data frame
sp.dat3.df = ldply(sp.dat3)
names(sp.dat3.df)=c("Serum measure", "rho", "p-value")
sp.dat3.df

```


```{r}

save(sp.dat1.df,  sp.dat3.df, file="section3-dat-log.RData")

```

